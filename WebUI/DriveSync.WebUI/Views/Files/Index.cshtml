@model IEnumerable<DriveSync.Shared.Models.FileRecord>
@{
    ViewData["Title"] = "Indexed Files";
    var currentPage = (int)ViewBag.CurrentPage;
    var totalPages = (int)ViewBag.TotalPages;
    var totalCount = (int)ViewBag.TotalCount;
    var pageSize = (int)ViewBag.PageSize;
    var searchTerm = ViewBag.SearchTerm?.ToString() ?? "";
    var sortBy = ViewBag.SortBy?.ToString() ?? "IndexedDate";
    var sortAscending = (bool)ViewBag.SortAscending;
    var isActive = ViewBag.IsActive as bool?;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-folder-open me-2 text-primary"></i>Indexed Files</h2>
    <div class="pagination-info">
        Showing @((currentPage - 1) * pageSize + 1) to @(Math.Min(currentPage * pageSize, totalCount)) of @totalCount files
    </div>
</div>

<!-- Success/Error Messages Container -->
<div id="messagesContainer"></div>

<div class="search-container">
    <div class="row g-3">
        <div class="col-md-4">
            <label for="searchInput" class="form-label">Search Files</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search by filename or path..." value="@searchTerm">
            </div>
        </div>
        <div class="col-md-2">
            <label for="pageSizeSelect" class="form-label">Page Size</label>
            <select class="form-select" id="pageSizeSelect">
                <option value="25" @(pageSize == 25 ? "selected" : "")>25</option>
                <option value="50" @(pageSize == 50 ? "selected" : "")>50</option>
                <option value="100" @(pageSize == 100 ? "selected" : "")>100</option>
                <option value="200" @(pageSize == 200 ? "selected" : "")>200</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="statusFilter" class="form-label">Status</label>
            <select class="form-select" id="statusFilter">
                <option value="" @(!isActive.HasValue ? "selected" : "")>All Files</option>
                <option value="true" @(isActive == true ? "selected" : "")>Active Only</option>
                <option value="false" @(isActive == false ? "selected" : "")>Inactive Only</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="sortBySelect" class="form-label">Sort By</label>
            <select class="form-select" id="sortBySelect">
                <option value="FileName" @(sortBy == "FileName" ? "selected" : "")>File Name</option>
                <option value="RelativePath" @(sortBy == "RelativePath" ? "selected" : "")>Path</option>
                <option value="FileSizeBytes" @(sortBy == "FileSizeBytes" ? "selected" : "")>File Size</option>
                <option value="CreationDate" @(sortBy == "CreationDate" ? "selected" : "")>Created Date</option>
                <option value="ModificationDate" @(sortBy == "ModificationDate" ? "selected" : "")>Modified Date</option>
                <option value="IndexedDate" @(sortBy == "IndexedDate" ? "selected" : "")>Indexed Date</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Sort Order</label>
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="sortOrder" id="sortAsc" value="true" @(sortAscending ? "checked" : "")>
                <label class="btn btn-outline-primary" for="sortAsc"><i class="fas fa-sort-alpha-down"></i></label>
                <input type="radio" class="btn-check" name="sortOrder" id="sortDesc" value="false" @(!sortAscending ? "checked" : "")>
                <label class="btn btn-outline-primary" for="sortDesc"><i class="fas fa-sort-alpha-down-alt"></i></label>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search me-1"></i>Search</button>
            <button class="btn btn-outline-secondary ms-2" id="clearBtn"><i class="fas fa-times me-1"></i>Clear</button>
            <button class="btn btn-outline-info ms-2" id="refreshBtn"><i class="fas fa-sync-alt me-1"></i>Refresh</button>
            <button class="btn btn-outline-warning ms-2" id="syncBtn"><i class="fas fa-cloud-upload-alt me-1"></i>Sync to Remote</button>
        </div>
    </div>
</div>

<!-- Bulk Actions Toolbar -->
<div class="bulk-actions-toolbar mb-3" id="bulkActionsToolbar" style="display: none;">
    <div class="d-flex align-items-center gap-3 p-3 bg-light border rounded">
        <span class="text-muted">
            <i class="fas fa-check-square me-1"></i>
            <span id="selectedCount">0</span> file(s) selected
        </span>
        <button class="btn btn-danger btn-sm" id="bulkDeleteBtn">
            <i class="fas fa-trash me-1"></i>Mark Selected as Inactive
        </button>
        <button class="btn btn-outline-secondary btn-sm" id="clearSelectionBtn">
            <i class="fas fa-times me-1"></i>Clear Selection
        </button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" title="Select All">
                </th>
                <th>File Name</th>
                <th>Path</th>
                <th>Size</th>
                <th>Created</th>
                <th>Modified</th>
                <th>Indexed</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="filesTableBody">
            @foreach (var file in Model)
            {
                <tr class="@(file.IsActive ? "" : "table-warning")">
                    <td>
                        @if (file.IsActive)
                        {
                            <input type="checkbox" class="file-checkbox" data-file-id="@file.Id">
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        <span class="file-name" title="@file.FileName">
                            <i class="fas fa-file me-1 text-muted"></i>
                            @file.FileName
                        </span>
                    </td>
                    <td>
                        <span class="file-path" title="@file.GetFullRelativePath()">@file.GetFullRelativePath()</span>
                    </td>
                    <td>@file.FileSizeFormatted</td>
                    <td>@file.CreationDate.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>@file.ModificationDate.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>@file.IndexedDate.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        @if (file.IsActive)
                        {
                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Active</span>
                        }
                        else
                        {
                            <span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>Inactive</span>
                        }
                    </td>
                    <td>
                        @if (file.IsActive)
                        {
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-file-id="@file.Id" data-file-name="@file.FileName" title="Mark as inactive">
                                <i class="fas fa-trash"></i>
                            </button>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (totalPages > 1)
{
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination will be generated by JavaScript -->
        </ul>
    </nav>
}

@section Scripts {
    <script>
        let currentPage = @currentPage;
        let totalPages = @totalPages;
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', function() {
            updatePagination();
            
            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // Clear functionality
            document.getElementById('clearBtn').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('sortBySelect').value = 'IndexedDate';
                document.querySelector('input[name="sortOrder"][value="false"]').checked = true;
                document.getElementById('pageSizeSelect').value = '50';
                performSearch();
            });
            
            // Refresh functionality
            document.getElementById('refreshBtn').addEventListener('click', performSearch);
            
            // Sync functionality
            document.getElementById('syncBtn').addEventListener('click', function() {
                syncToRemote();
            });
            
            // Auto-search on filter changes
            document.getElementById('pageSizeSelect').addEventListener('change', performSearch);
            document.getElementById('statusFilter').addEventListener('change', performSearch);
            document.getElementById('sortBySelect').addEventListener('change', performSearch);
            document.querySelectorAll('input[name="sortOrder"]').forEach(radio => {
                radio.addEventListener('change', performSearch);
            });
        });

        function performSearch(page = 1) {
            if (isLoading) return;
            
            isLoading = true;
            showLoading();
            
            const searchTerm = document.getElementById('searchInput').value;
            const pageSize = document.getElementById('pageSizeSelect').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBySelect').value;
            const sortAscending = document.querySelector('input[name="sortOrder"]:checked').value === 'true';
            
            const params = new URLSearchParams({
                page: page,
                pageSize: pageSize,
                searchTerm: searchTerm,
                sortBy: sortBy,
                sortAscending: sortAscending
            });
            
            if (statusFilter !== '') {
                params.append('isActive', statusFilter);
            }
            
            fetch(`/Files/GetFilesData?${params}`)
                .then(response => response.json())
                .then(data => {
                    updateTable(data.files);
                    updatePaginationInfo(data.currentPage, data.totalPages, data.totalCount, pageSize);
                    currentPage = data.currentPage;
                    totalPages = data.totalPages;
                    updatePagination();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading data. Please try again.');
                })
                .finally(() => {
                    isLoading = false;
                    hideLoading();
                });
        }

        function updateTable(files) {
            const tbody = document.getElementById('filesTableBody');
            tbody.innerHTML = '';
            
            files.forEach(file => {
                const row = document.createElement('tr');
                row.className = file.isActive ? '' : 'table-warning';
                row.innerHTML = `
                    <td>
                        ${file.isActive 
                            ? `<input type="checkbox" class="file-checkbox" data-file-id="${file.id}">`
                            : '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>
                        <span class="file-name" title="${escapeHtml(file.fileName)}">
                            <i class="fas fa-file me-1 text-muted"></i>
                            ${escapeHtml(file.fileName)}
                        </span>
                    </td>
                    <td>
                        <span class="file-path" title="${escapeHtml(file.fullPath)}">${escapeHtml(file.fullPath)}</span>
                    </td>
                    <td>${escapeHtml(file.fileSizeFormatted)}</td>
                    <td>${formatDate(file.creationDate)}</td>
                    <td>${formatDate(file.modificationDate)}</td>
                    <td>${formatDate(file.indexedDate)}</td>
                    <td>
                        ${file.isActive 
                            ? '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Active</span>'
                            : '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>Inactive</span>'
                        }
                    </td>
                    <td>
                        ${file.isActive 
                            ? `<button class="btn btn-sm btn-outline-danger delete-btn" data-file-id="${file.id}" data-file-name="${escapeHtml(file.fileName)}" title="Mark as inactive">
                                <i class="fas fa-trash"></i>
                            </button>`
                            : '<span class="text-muted">-</span>'
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Reattach event listeners for the new delete buttons
            reattachEventListeners();
        }

        function updatePaginationInfo(page, totalPagesCount, totalCount, pageSize) {
            const start = (page - 1) * pageSize + 1;
            const end = Math.min(page * pageSize, totalCount);
            document.querySelector('.pagination-info').textContent = 
                `Showing ${start} to ${end} of ${totalCount} files`;
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            if (!pagination) return;
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(1)">1</a>`;
                pagination.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${totalPages})">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage || isLoading) return;
            performSearch(page);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-CA', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(',', '');
        }

        // Delete functionality
        function attachDeleteEventListeners() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const fileId = this.getAttribute('data-file-id');
                    const fileName = this.getAttribute('data-file-name');
                    confirmDelete(fileId, fileName);
                });
            });
        }

        function confirmDelete(fileId, fileName) {
            if (confirm(`Are you sure you want to mark "${fileName}" as inactive? This action will set the file as inactive and update its modification date.`)) {
                deleteFile(fileId);
            }
        }

        async function deleteFile(fileId) {
            try {
                showLoading();
                
                const formData = new FormData();
                formData.append('id', fileId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
                
                const response = await fetch('/Files/DeleteFile', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    // Refresh the current page to show updated data
                    performSearch(currentPage);
                    
                    // Show success message
                    showSuccessMessage(result.message);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('An error occurred while trying to delete the file.');
            } finally {
                hideLoading();
            }
        }

        // Call this after each AJAX load to reattach event listeners
        function reattachEventListeners() {
            attachDeleteEventListeners();
        }

        // Sync to remote database functionality
        async function syncToRemote() {
            if (!confirm('Are you sure you want to sync all local changes to the remote database? This will overwrite the remote database with local changes.')) {
                return;
            }

            try {
                showLoading();
                
                const response = await fetch('/Files/SyncToRemote', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${result.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.search-container'));
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 5000);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Sync error:', error);
                alert('An error occurred while trying to sync to remote database.');
            } finally {
                hideLoading();
            }
        }

        // Initial attachment of event listeners
        document.addEventListener('DOMContentLoaded', function() {
            attachDeleteEventListeners();
            attachBulkActionEventListeners();
        });

        // Handle browser close/refresh to sync database
        window.addEventListener('beforeunload', function(event) {
            // Attempt emergency sync before page unloads
            try {
                navigator.sendBeacon('/Files/EmergencySync', new FormData());
            } catch (error) {
                console.warn('Emergency sync beacon failed:', error);
            }
        });

        // Bulk operations functionality
        function attachBulkActionEventListeners() {
            // Select all checkbox
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.file-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBulkActionsToolbar();
            });

            // Individual checkboxes
            document.addEventListener('change', function(event) {
                if (event.target.classList.contains('file-checkbox')) {
                    updateSelectAllState();
                    updateBulkActionsToolbar();
                }
            });

            // Bulk delete button
            document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
                const selectedIds = getSelectedFileIds();
                if (selectedIds.length > 0) {
                    confirmBulkDelete(selectedIds);
                }
            });

            // Clear selection button
            document.getElementById('clearSelectionBtn').addEventListener('click', function() {
                clearAllSelections();
            });
        }

        function getSelectedFileIds() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-file-id')));
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAll');

            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }

        function updateBulkActionsToolbar() {
            const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
            const toolbar = document.getElementById('bulkActionsToolbar');
            const countSpan = document.getElementById('selectedCount');

            countSpan.textContent = selectedCount;

            if (selectedCount > 0) {
                toolbar.style.display = 'block';
            } else {
                toolbar.style.display = 'none';
            }
        }

        function clearAllSelections() {
            document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAll').indeterminate = false;
            updateBulkActionsToolbar();
        }

        function confirmBulkDelete(fileIds) {
            const count = fileIds.length;
            if (confirm(`Are you sure you want to mark ${count} selected file(s) as inactive? This action will set them as inactive and update their modification dates.`)) {
                bulkDeleteFiles(fileIds);
            }
        }

        async function bulkDeleteFiles(fileIds) {
            try {
                showLoading();
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
                
                // Add each file ID to the form data
                fileIds.forEach((id, index) => {
                    formData.append(`[${index}]`, id);
                });
                
                const response = await fetch('/Files/BulkDeleteFiles', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Bulk delete API response:', result);
                
                if (result.success) {
                    // Clear selections and refresh table
                    clearAllSelections();
                    performSearch(currentPage);
                    
                    // Show success message using a simpler approach
                    showSuccessMessage(result.message);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Bulk delete error:', error);
                alert('An error occurred while trying to delete the selected files. Check the console for details.');
            } finally {
                hideLoading();
            }
        }

        function showSuccessMessage(message) {
            try {
                // Use the dedicated messages container
                const messagesContainer = document.getElementById('messagesContainer');
                
                if (!messagesContainer) {
                    throw new Error('Messages container not found');
                }
                
                // Clear any existing messages
                messagesContainer.innerHTML = '';
                
                // Create the alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mb-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Simply append to the dedicated container
                messagesContainer.appendChild(alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv && alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
                
                console.log('Success message displayed successfully');
            } catch (error) {
                console.error('Error showing success message:', error);
                // Fallback to simple alert
                alert('Success: ' + message);
            }
        }

        // Update reattachEventListeners to include bulk operations
        function reattachEventListeners() {
            attachDeleteEventListeners();
            // Note: Bulk action listeners are attached to document, so they don't need reattaching
            updateSelectAllState();
            updateBulkActionsToolbar();
        }
    </script>
}